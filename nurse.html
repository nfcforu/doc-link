<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tableau de bord Clinique taniket dot com </title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-color: #2563eb;
        --secondary-color: #1e40af;
        --text-color: #1f2937;
        --bg-color: #f3f4f6;
        --card-bg: #ffffff;
        --success-color: #10b981;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
        --border-color: #e5e7eb;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        min-height: 100vh;
      }

      .dashboard-header {
        background: var(--card-bg);
        border-bottom: 2px solid var(--border-color);
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .logo-small {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
      }

      .header-title h1 {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 2px;
      }

      .header-title p {
        font-size: 14px;
        color: #6b7280;
      }

      .header-right {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .date-filter {
        padding: 10px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        background: white;
      }

      .refresh-btn {
        padding: 10px 20px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .refresh-btn:hover {
        background: var(--secondary-color);
      }

      .dashboard-content {
        padding: 30px;
        max-width: 1400px;
        margin: 0 auto;
      }

      .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .stat-label {
        font-size: 13px;
        color: #6b7280;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--primary-color);
      }

      .table-container {
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        overflow: hidden;
      }

      .table-header {
        padding: 20px 30px;
        border-bottom: 2px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
      }

      .table-title {
        font-size: 18px;
        font-weight: 700;
      }

      .filter-buttons {
        display: flex;
        gap: 8px;
        background: #f3f4f6;
        padding: 4px;
        border-radius: 8px;
      }

      .filter-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        background: transparent;
        color: #6b7280;
      }

      .filter-btn.active {
        background: white;
        color: var(--primary-color);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .table-wrapper {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        background: #f9fafb;
      }

      th {
        text-align: left;
        padding: 16px 24px;
        font-size: 13px;
        font-weight: 700;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid var(--border-color);
      }

      td {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        font-size: 15px;
      }

      tbody tr {
        transition: background 0.2s ease;
      }

      tbody tr:hover {
        background: #f9fafb;
      }

      tbody tr.consulted {
        background: #d1fae5;
      }

      tbody tr.no-show {
        background: #fef3c7;
      }

      .position-badge {
        display: inline-block;
        width: 32px;
        height: 32px;
        background: var(--primary-color);
        color: white;
        border-radius: 50%;
        text-align: center;
        line-height: 32px;
        font-weight: 700;
        font-size: 14px;
      }

      .time-badge {
        display: inline-block;
        padding: 4px 12px;
        background: #dbeafe;
        color: #1e40af;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
      }

      .status-dropdown {
        padding: 8px 12px;
        border: 2px solid var(--border-color);
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        background: white;
        min-width: 140px;
      }

      .status-dropdown.waiting {
        border-color: #3b82f6;
        color: #1e40af;
      }

      .status-dropdown.consulted {
        border-color: #10b981;
        color: #065f46;
      }

      .status-dropdown.no-show {
        border-color: #f59e0b;
        color: #92400e;
      }

      .action-buttons {
        display: flex;
        gap: 8px;
      }

      .action-btn {
        padding: 8px 12px;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .edit-btn {
        background: var(--primary-color);
      }

      .edit-btn:hover {
        background: var(--secondary-color);
      }

      .delete-btn {
        background: var(--danger-color);
      }

      .delete-btn:hover {
        background: #dc2626;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6b7280;
      }

      .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
      }

      .empty-state-text {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .empty-state-subtext {
        font-size: 14px;
      }

      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s;
      }

      .modal.show {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal-content {
        background: white;
        border-radius: 16px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideUp 0.3s;
      }

      @keyframes slideUp {
        from {
          transform: translateY(50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }

      .modal-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-color);
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        color: #6b7280;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.3s ease;
      }

      .close-btn:hover {
        background: #f3f4f6;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-color);
      }

      .form-group input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 15px;
        transition: all 0.3s ease;
      }

      .form-group input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 24px;
      }

      .modal-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .modal-btn.cancel {
        background: #f3f4f6;
        color: #6b7280;
      }

      .modal-btn.cancel:hover {
        background: #e5e7eb;
      }

      .modal-btn.save {
        background: var(--primary-color);
        color: white;
      }

      .modal-btn.save:hover {
        background: var(--secondary-color);
      }

      @media (max-width: 768px) {
        .dashboard-header {
          padding: 15px 20px;
        }

        .dashboard-content {
          padding: 20px 15px;
        }

        .header-title h1 {
          font-size: 20px;
        }

        .stats-container {
          grid-template-columns: repeat(2, 1fr);
        }

        .table-header {
          padding: 15px 20px;
        }

        th,
        td {
          padding: 12px 16px;
          font-size: 13px;
        }

        .stat-value {
          font-size: 24px;
        }

        .action-buttons {
          flex-direction: column;
        }

        .filter-buttons {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-header">
      <div class="header-left">
        <div class="logo-small">üè•</div>
        <div class="header-title">
          <h1 id="dashboardTitle">Tableau de bord Clinique</h1>
          <p id="dashboardSubtitle">
            Gestion de la file d'attente des patients
          </p>
        </div>
      </div>
      <div class="header-right">
        <input
          type="text"
          id="searchInput"
          class="date-filter"
          placeholder="üîç Rechercher par N¬∞ de suivi"
          style="min-width: 250px"
        />
        <input type="date" id="dateFilter" class="date-filter" />
        <button class="refresh-btn" onclick="loadReservations()">
          üîÑ Actualiser
        </button>
        <button
          class="refresh-btn"
          style="background: var(--success-color)"
          onclick="openAddModal()"
        >
          ‚ûï Nouvelle r√©servation
        </button>
      </div>
    </div>

    <div class="dashboard-content">
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-label">Total</div>
          <div class="stat-value" id="totalCount">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">En Attente</div>
          <div class="stat-value" id="waitingCount">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Consult√©s</div>
          <div class="stat-value" id="consultedCount">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Pas Venu</div>
          <div class="stat-value" id="noShowCount">0</div>
        </div>
      </div>

      <div class="table-container">
        <div class="table-header">
          <h2 class="table-title">File d'attente des patients</h2>
          <div class="filter-buttons">
            <button
              class="filter-btn active"
              onclick="setFilter('all')"
              id="filterAll"
            >
              Tous
            </button>
            <button
              class="filter-btn"
              onclick="setFilter('waiting')"
              id="filterWaiting"
            >
              En attente
            </button>
            <button
              class="filter-btn"
              onclick="setFilter('consulted')"
              id="filterConsulted"
            >
              Consult√©s
            </button>
            <button
              class="filter-btn"
              onclick="setFilter('no-show')"
              id="filterNoShow"
            >
              Pas venu
            </button>
          </div>
        </div>
        <div class="table-wrapper">
          <table id="reservationsTable">
            <thead>
              <tr>
                <th>#</th>
                <th>N¬∞ Suivi</th>
                <th>Nom</th>
                <th>T√©l√©phone</th>
                <th>√Çge</th>
                <th>Date</th>
                <th>Heure</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <!-- Les donn√©es seront ins√©r√©es ici -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Modifier la r√©servation</h2>
          <button class="close-btn" onclick="closeEditModal()">√ó</button>
        </div>
        <form id="editForm">
          <input type="hidden" id="editId" />
          <div class="form-group">
            <label for="editTrackingNumber">Num√©ro de suivi</label>
            <input
              type="text"
              id="editTrackingNumber"
              readonly
              style="
                background: #f3f4f6;
                cursor: not-allowed;
                font-family: &quot;Courier New&quot;, monospace;
                color: #2563eb;
                font-weight: 600;
              "
            />
          </div>
          <div class="form-group">
            <label for="editName">Nom complet</label>
            <input type="text" id="editName" required />
          </div>
          <div class="form-group">
            <label for="editPhone">T√©l√©phone</label>
            <input type="tel" id="editPhone" required />
          </div>
          <div class="form-group">
            <label for="editAge">√Çge</label>
            <input type="number" id="editAge" min="1" max="150" required />
          </div>
          <div class="form-group">
            <label for="editDate">Date</label>
            <input type="date" id="editDate" required />
          </div>
          <div class="modal-actions">
            <button
              type="button"
              class="modal-btn cancel"
              onclick="closeEditModal()"
            >
              Annuler
            </button>
            <button type="submit" class="modal-btn save">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Add Modal -->
    <div id="addModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Nouvelle r√©servation</h2>
          <button class="close-btn" onclick="closeAddModal()">√ó</button>
        </div>
        <form id="addForm">
          <div class="form-group">
            <label for="addName">Nom complet</label>
            <input type="text" id="addName" required />
          </div>
          <div class="form-group">
            <label for="addPhone">T√©l√©phone</label>
            <input type="tel" id="addPhone" required />
          </div>
          <div class="form-group">
            <label for="addAge">√Çge</label>
            <input type="number" id="addAge" min="1" max="150" required />
          </div>
          <div class="form-group">
            <label for="addDate">Date</label>
            <input type="date" id="addDate" required />
          </div>
          <div class="modal-actions">
            <button
              type="button"
              class="modal-btn cancel"
              onclick="closeAddModal()"
            >
              Annuler
            </button>
            <button type="submit" class="modal-btn save">Ajouter</button>
          </div>
        </form>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // ============================================
      // CONFIGURATION SUPABASE
      // ============================================
      const SUPABASE_URL = "https://xgahasrfktpyldjkndhh.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnYWhhc3Jma3RweWxkamtuZGhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5MDMyMzgsImV4cCI6MjA4MjQ3OTIzOH0.0Oec4OpBjHS5OL6QMY3bvs3jT2KGfkvECgGKZfNLXb4";

      // Initialiser le client Supabase
      const supabaseClient = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_KEY,
      );

      // Get clinic ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      const clinicId = urlParams.get("clinic");

      // ============================================
      // CONFIGURATION DE LA MARQUE
      // ============================================
      let clinicConfig = {
        id: null,
        name: "Clinique M√©dicale",
        subtitle: "Gestion de la file d'attente des patients",
        primaryColor: "#2563eb",
        secondaryColor: "#1e40af",
      };

      // √âtat du filtre
      let currentFilter = "all";
      let allReservations = [];

      // Load clinic configuration
      async function loadClinicConfig() {
        if (!clinicId) {
          console.warn("No clinic ID provided");
          applyBranding();
          return;
        }

        try {
          const { data, error } = await supabaseClient
            .from("clinics")
            .select("*")
            .eq("id", clinicId)
            .eq("active", true)
            .single();

          if (error) throw error;

          if (data) {
            clinicConfig = {
              id: data.id,
              name: data.name,
              subtitle:
                data.subtitle || "Gestion de la file d'attente des patients",
              primaryColor: data.primary_color,
              secondaryColor: data.secondary_color,
            };
          }

          applyBranding();
        } catch (error) {
          console.error("Error loading clinic config:", error);
          document.body.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; text-align: center; padding: 20px;">
                        <div>
                            <h1 style="font-size: 48px; margin-bottom: 20px;">‚ùå</h1>
                            <h2 style="font-size: 24px; color: #1f2937; margin-bottom: 10px;">Clinique introuvable</h2>
                            <p style="color: #6b7280;">L'URL de cette clinique est invalide ou la clinique est inactive.</p>
                        </div>
                    </div>
                `;
        }
      }

      // Appliquer la marque
      function applyBranding() {
        document.getElementById("dashboardTitle").textContent =
          "Tableau de bord " + clinicConfig.name;
        document.getElementById("dashboardSubtitle").textContent =
          clinicConfig.subtitle;

        document.documentElement.style.setProperty(
          "--primary-color",
          clinicConfig.primaryColor,
        );
        document.documentElement.style.setProperty(
          "--secondary-color",
          clinicConfig.secondaryColor,
        );
      }

      // D√©finir le filtre de date √† aujourd'hui
      function setDateFilter() {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("dateFilter").value = today;
      }

      // Changer le filtre
      function setFilter(filter) {
        currentFilter = filter;

        // Mettre √† jour les boutons actifs
        document
          .querySelectorAll(".filter-btn")
          .forEach((btn) => btn.classList.remove("active"));

        if (filter === "all") {
          document.getElementById("filterAll").classList.add("active");
        } else if (filter === "waiting") {
          document.getElementById("filterWaiting").classList.add("active");
        } else if (filter === "consulted") {
          document.getElementById("filterConsulted").classList.add("active");
        } else if (filter === "no-show") {
          document.getElementById("filterNoShow").classList.add("active");
        }

        // R√©afficher le tableau avec le filtre
        updateTable(allReservations);
      }

      // Formater l'heure
      function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString("fr-FR", {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // Charger les r√©servations depuis Supabase
      async function loadReservations() {
        const selectedDate = document.getElementById("dateFilter").value;
        const searchQuery = document
          .getElementById("searchInput")
          .value.trim()
          .toUpperCase();

        if (!clinicConfig.id) {
          console.warn("No clinic ID");
          return;
        }

        try {
          let query = supabaseClient
            .from("reservations")
            .select("*")
            .eq("clinic_id", clinicConfig.id);

          // Si recherche par num√©ro de suivi
          if (searchQuery) {
            query = query.ilike("tracking_number", `%${searchQuery}%`);
            // R√©initialiser le filtre √† "Tous" lors de la recherche
            if (currentFilter !== "all") {
              currentFilter = "all";
              document
                .querySelectorAll(".filter-btn")
                .forEach((btn) => btn.classList.remove("active"));
              document.getElementById("filterAll").classList.add("active");
            }
          } else {
            // Sinon filtrer par date
            query = query.eq("date", selectedDate);
          }

          query = query.order("timestamp", { ascending: true });

          const { data: reservations, error: resError } = await query;

          if (resError) throw resError;

          // Charger les statuts
          const { data: statuses, error: statusError } = await supabaseClient
            .from("patient_status")
            .select("*");

          if (statusError) throw statusError;

          // Combiner r√©servations avec statuts
          allReservations = (reservations || []).map((res) => {
            const statusRecord = statuses?.find(
              (s) => s.reservation_id === res.id,
            );
            return {
              ...res,
              status: statusRecord ? statusRecord.status : "waiting",
            };
          });

          // Mettre √† jour les statistiques
          updateStats(allReservations);

          // Mettre √† jour le tableau
          updateTable(allReservations);
        } catch (error) {
          console.error("Erreur lors du chargement des r√©servations:", error);
          allReservations = [];
          updateStats([]);
          updateTable([]);
        }
      }

      // Mettre √† jour les statistiques
      function updateStats(reservations) {
        const waiting = reservations.filter(
          (r) => r.status === "waiting" || !r.status,
        ).length;
        const consulted = reservations.filter(
          (r) => r.status === "consulted",
        ).length;
        const noShow = reservations.filter(
          (r) => r.status === "no-show",
        ).length;

        document.getElementById("totalCount").textContent = reservations.length;
        document.getElementById("waitingCount").textContent = waiting;
        document.getElementById("consultedCount").textContent = consulted;
        document.getElementById("noShowCount").textContent = noShow;
      }

      // Mettre √† jour le tableau
      function updateTable(reservations) {
        const tbody = document.getElementById("tableBody");

        // Filtrer selon le filtre actif
        let filteredReservations = reservations;
        if (currentFilter === "waiting") {
          filteredReservations = reservations.filter(
            (r) => r.status === "waiting" || !r.status,
          );
        } else if (currentFilter === "consulted") {
          filteredReservations = reservations.filter(
            (r) => r.status === "consulted",
          );
        } else if (currentFilter === "no-show") {
          filteredReservations = reservations.filter(
            (r) => r.status === "no-show",
          );
        }

        if (filteredReservations.length === 0) {
          tbody.innerHTML = `
                    <tr>
                        <td colspan="9">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìã</div>
                                <div class="empty-state-text">Aucune r√©servation trouv√©e</div>
                                <div class="empty-state-subtext">Les patients appara√Ætront ici lorsqu'ils scanneront le tag NFC</div>
                            </div>
                        </td>
                    </tr>
                `;
          return;
        }

        tbody.innerHTML = filteredReservations
          .map((res, index) => {
            const status = res.status || "waiting";
            const rowClass =
              status === "consulted"
                ? "consulted"
                : status === "no-show"
                  ? "no-show"
                  : "";
            const trackingNumber = res.tracking_number || "N/A";

            return `
                <tr class="${rowClass}">
                    <td><span class="position-badge">${index + 1}</span></td>
                    <td><strong style="font-family: 'Courier New', monospace; color: var(--primary-color);">${trackingNumber}</strong></td>
                    <td><strong>${res.name}</strong></td>
                    <td>${res.phone}</td>
                    <td>${res.age}</td>
                    <td>${res.date}</td>
                    <td><span class="time-badge">${formatTime(res.timestamp)}</span></td>
                    <td>
                        <select class="status-dropdown ${status}" onchange="changeStatus(${res.id}, this.value)">
                            <option value="waiting" ${status === "waiting" ? "selected" : ""}>‚è≥ En attente</option>
                            <option value="consulted" ${status === "consulted" ? "selected" : ""}>‚úì Consult√©</option>
                            <option value="no-show" ${status === "no-show" ? "selected" : ""}>‚úó Pas venu</option>
                        </select>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit-btn" onclick='openEditModal(${JSON.stringify(res)})'>
                                ‚úèÔ∏è Modifier
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteReservation(${res.id})">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </td>
                </tr>
            `;
          })
          .join("");
      }

      // Changer le statut via dropdown
      async function changeStatus(id, newStatus) {
        try {
          if (newStatus === "waiting") {
            // Supprimer le statut pour revenir √† "en attente"
            const { error } = await supabaseClient
              .from("patient_status")
              .delete()
              .eq("reservation_id", id);
            if (error) throw error;
          } else {
            // Mettre √† jour le statut
            const { error } = await supabaseClient
              .from("patient_status")
              .upsert(
                {
                  reservation_id: id,
                  status: newStatus,
                  updated_at: new Date().toISOString(),
                },
                {
                  onConflict: "reservation_id",
                },
              );
            if (error) throw error;
          }
          loadReservations();
        } catch (error) {
          console.error("Erreur:", error);
          alert("√âchec de la mise √† jour du statut. Veuillez r√©essayer.");
          loadReservations();
        }
      }

      // Ouvrir le modal d'√©dition
      function openEditModal(reservation) {
        if (!reservation) return;

        document.getElementById("editId").value = reservation.id;
        document.getElementById("editTrackingNumber").value =
          reservation.tracking_number || "N/A";
        document.getElementById("editName").value = reservation.name;
        document.getElementById("editPhone").value = reservation.phone;
        document.getElementById("editAge").value = reservation.age;
        document.getElementById("editDate").value = reservation.date;

        document.getElementById("editModal").classList.add("show");
      }

      // Fermer le modal d'√©dition
      function closeEditModal() {
        document.getElementById("editModal").classList.remove("show");
      }

      // Ouvrir le modal d'ajout
      function openAddModal() {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("addDate").value = today;
        document.getElementById("addModal").classList.add("show");
      }

      // Fermer le modal d'ajout
      function closeAddModal() {
        document.getElementById("addModal").classList.remove("show");
        document.getElementById("addForm").reset();
        // Cacher les messages d'erreur
        document
          .querySelectorAll("#addForm .input-error")
          .forEach((el) => (el.style.display = "none"));
      }

      // G√©n√©rer un num√©ro de suivi unique
      function generateTrackingNumber() {
        const prefix = "TRK";
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.floor(Math.random() * 1000)
          .toString()
          .padStart(3, "0");
        return `${prefix}${timestamp}${random}`;
      }

      // Validation en temps r√©el pour le formulaire d'ajout
      const addNameInput = document.getElementById("addName");
      const addPhoneInput = document.getElementById("addPhone");
      const addAgeInput = document.getElementById("addAge");

      addNameInput.addEventListener("input", function () {
        const error = document.getElementById("addNameError");
        if (this.value.trim().length < 3 && this.value.length > 0) {
          error.style.display = "block";
        } else {
          error.style.display = "none";
        }
      });

      addPhoneInput.addEventListener("input", function () {
        let value = this.value.replace(/\D/g, "");
        if (value.length > 10) value = value.slice(0, 10);
        this.value = value;

        const error = document.getElementById("addPhoneError");
        const isValid = /^0[5-7][0-9]{8}$/.test(value);
        if (value.length > 0 && !isValid) {
          error.style.display = "block";
        } else {
          error.style.display = "none";
        }
      });

      addAgeInput.addEventListener("input", function () {
        const error = document.getElementById("addAgeError");
        const value = parseInt(this.value);
        if (this.value && (value < 1 || value > 120)) {
          error.style.display = "block";
        } else {
          error.style.display = "none";
        }
      });

      // G√©rer la soumission du formulaire d'√©dition
      document
        .getElementById("editForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const id = parseInt(document.getElementById("editId").value);
          const originalDate = allReservations.find((r) => r.id === id)?.date;
          const newDate = document.getElementById("editDate").value;

          const updatedData = {
            name: document.getElementById("editName").value,
            phone: document.getElementById("editPhone").value,
            age: parseInt(document.getElementById("editAge").value),
            date: newDate,
          };

          // Si la date a chang√©, mettre √† jour le timestamp pour placer √† la fin de la file
          if (originalDate !== newDate) {
            updatedData.timestamp = new Date().toISOString();
          }

          console.log(
            "Updating reservation ID:",
            id,
            "with data:",
            updatedData,
          );

          try {
            const { data, error } = await supabaseClient
              .from("reservations")
              .update(updatedData)
              .eq("id", id)
              .select();

            console.log("Response:", { data, error });

            if (error) {
              console.error("Update error:", error);
              throw error;
            }

            if (!data || data.length === 0) {
              console.warn("No rows updated - checking if record exists");
              const { data: existing } = await supabaseClient
                .from("reservations")
                .select("*")
                .eq("id", id);
              console.log("Existing record:", existing);
            }

            // Si la date a chang√©, r√©initialiser le statut √† "waiting"
            if (originalDate !== newDate) {
              await supabaseClient
                .from("patient_status")
                .delete()
                .eq("reservation_id", id);
            }

            closeEditModal();
            setTimeout(() => loadReservations(), 500);
            alert("R√©servation modifi√©e avec succ√®s !");
          } catch (error) {
            console.error("Erreur compl√®te:", error);
            alert("√âchec de la modification: " + error.message);
          }
        });

      // Supprimer une r√©servation
      async function deleteReservation(id) {
        if (
          !confirm("√ätes-vous s√ªr de vouloir supprimer cette r√©servation ?")
        ) {
          return;
        }

        try {
          // Supprimer le statut d'abord
          await supabaseClient
            .from("patient_status")
            .delete()
            .eq("reservation_id", id);

          // Supprimer la r√©servation
          const { error } = await supabaseClient
            .from("reservations")
            .delete()
            .eq("id", id);

          if (error) throw error;

          loadReservations();
          alert("R√©servation supprim√©e avec succ√®s !");
        } catch (error) {
          console.error("Erreur:", error);
          alert("√âchec de la suppression. Veuillez r√©essayer.");
        }
      }

      // Fermer le modal en cliquant √† l'ext√©rieur
      window.onclick = function (event) {
        const editModal = document.getElementById("editModal");
        const addModal = document.getElementById("addModal");
        if (event.target === editModal) {
          closeEditModal();
        }
        if (event.target === addModal) {
          closeAddModal();
        }
      };

      // G√©rer la soumission du formulaire d'ajout
      document
        .getElementById("addForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Validation finale
          const name = document.getElementById("addName").value.trim();
          const phone = document.getElementById("addPhone").value.trim();
          const age = parseInt(document.getElementById("addAge").value);

          let hasError = false;

          if (name.length < 3) {
            document.getElementById("addNameError").style.display = "block";
            hasError = true;
          }

          if (!/^0[5-7][0-9]{8}$/.test(phone)) {
            document.getElementById("addPhoneError").style.display = "block";
            hasError = true;
          }

          if (age < 1 || age > 120) {
            document.getElementById("addAgeError").style.display = "block";
            hasError = true;
          }

          if (hasError) return;

          const trackingNumber = generateTrackingNumber();

          const newReservation = {
            name: name,
            phone: phone,
            age: age,
            date: document.getElementById("addDate").value,
            tracking_number: trackingNumber,
            clinic_id: clinicConfig.id,
          };

          console.log("Adding new reservation:", newReservation);

          try {
            const { data, error } = await supabaseClient
              .from("reservations")
              .insert([newReservation])
              .select();

            if (error) {
              console.error("Insert error:", error);
              throw error;
            }

            console.log("Insert successful:", data);

            closeAddModal();
            await loadReservations();
            alert(
              `R√©servation ajout√©e avec succ√®s !\n\nNum√©ro de suivi: ${trackingNumber}`,
            );
          } catch (error) {
            console.error("Erreur compl√®te:", error);
            alert("√âchec de l'ajout: " + error.message);
          }
        });

      // S'abonner aux changements en temps r√©el
      function setupRealtimeSubscription() {
        // √âcouter les changements dans la table reservations
        supabaseClient
          .channel("reservations-changes")
          .on(
            "postgres_changes",
            { event: "*", schema: "public", table: "reservations" },
            (payload) => {
              console.log("Changement r√©servations d√©tect√©:", payload);
              loadReservations();
            },
          )
          .subscribe();

        // √âcouter les changements dans la table patient_status
        supabaseClient
          .channel("status-changes")
          .on(
            "postgres_changes",
            { event: "*", schema: "public", table: "patient_status" },
            (payload) => {
              console.log("Changement statut d√©tect√©:", payload);
              loadReservations();
            },
          )
          .subscribe();
      }

      // √âcouter les changements du filtre de date
      document
        .getElementById("dateFilter")
        .addEventListener("change", loadReservations);

      // √âcouter les changements de la recherche
      document
        .getElementById("searchInput")
        .addEventListener("input", loadReservations);

      // Initialiser
      loadClinicConfig().then(() => {
        applyBranding();
        setDateFilter();
        loadReservations();
        setupRealtimeSubscription();
      });
    </script>
  </body>
</html>


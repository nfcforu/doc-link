<!doctype html>
<html lang="fr" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>R√©servation Clinique</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-color: #2563eb;
        --secondary-color: #1e40af;
        --text-color: #1f2937;
        --bg-color: #f3f4f6;
        --card-bg: #ffffff;
        --success-color: #10b981;
        --error-color: #ef4444;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: var(--text-color);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: var(--card-bg);
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 100%;
        padding: 50px 40px;
        position: relative;
        overflow: hidden;
      }

      .container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(
          90deg,
          var(--primary-color),
          var(--success-color)
        );
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      .logo-container {
        width: 100px;
        height: 100px;
        margin: 0 auto 20px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(37, 99, 235, 0.3);
      }

      .logo-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .logo-placeholder {
        font-size: 48px;
        color: white;
      }

      .clinic-name {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-color);
        margin-bottom: 8px;
      }

      .clinic-subtitle {
        font-size: 15px;
        color: #6b7280;
        font-weight: 500;
      }

      .form-info {
        background: #f0f9ff;
        border-left: 4px solid var(--primary-color);
        padding: 16px;
        margin-bottom: 30px;
        border-radius: 8px;
      }

      .form-info-text {
        font-size: 14px;
        color: #1e40af;
        line-height: 1.6;
      }

      .form-group {
        margin-bottom: 28px;
        position: relative;
      }

      label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .required-star {
        color: var(--error-color);
        font-size: 16px;
      }

      input {
        width: 100%;
        padding: 16px 50px 16px 18px;
        font-size: 16px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        background: white;
        color: var(--text-color);
        transition: all 0.3s ease;
        font-family: inherit;
      }

      input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        transform: translateY(-2px);
      }

      input.valid {
        border-color: var(--success-color);
        background: #f0fdf4;
      }

      input.error {
        border-color: var(--error-color);
        background: #fef2f2;
        animation: shake 0.3s;
      }

      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-10px);
        }
        75% {
          transform: translateX(10px);
        }
      }

      .input-hint {
        font-size: 12px;
        color: #6b7280;
        margin-top: 6px;
        display: none;
      }

      .input-error {
        font-size: 12px;
        color: var(--error-color);
        margin-top: 6px;
        display: none;
        align-items: center;
        gap: 4px;
      }

      input.error ~ .input-error {
        display: flex;
      }

      .input-icon {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 20px;
        opacity: 0;
        transition: all 0.3s ease;
        pointer-events: none;
      }

      .input-icon.show {
        opacity: 1;
      }

      .input-icon.valid {
        color: var(--success-color);
      }

      .input-icon.error {
        color: var(--error-color);
      }

      .char-counter {
        font-size: 12px;
        color: #9ca3af;
        text-align: right;
        margin-top: 4px;
      }

      .submit-btn {
        width: 100%;
        padding: 18px;
        font-size: 17px;
        font-weight: 600;
        color: white;
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
        position: relative;
        overflow: hidden;
      }

      .submit-btn::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition:
          width 0.6s,
          height 0.6s;
      }

      .submit-btn:hover::before {
        width: 300px;
        height: 300px;
      }

      .submit-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(37, 99, 235, 0.5);
      }

      .submit-btn:active {
        transform: translateY(-1px);
      }

      .submit-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .submit-btn span {
        position: relative;
        z-index: 1;
      }

      /* Success Modal */
      .success-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        animation: fadeIn 0.3s;
        backdrop-filter: blur(5px);
      }

      .success-modal.show {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .success-modal-content {
        background: white;
        border-radius: 24px;
        padding: 50px 40px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        animation: slideUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
        position: relative;
      }

      .success-modal-content::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: linear-gradient(
          90deg,
          var(--success-color),
          var(--primary-color)
        );
        border-radius: 24px 24px 0 0;
      }

      @keyframes slideUp {
        from {
          transform: translateY(100px) scale(0.8);
          opacity: 0;
        }
        to {
          transform: translateY(0) scale(1);
          opacity: 1;
        }
      }

      .success-icon {
        width: 100px;
        height: 100px;
        background: linear-gradient(135deg, var(--success-color), #059669);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
        font-size: 56px;
        animation: successPulse 1s infinite;
        box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
      }

      @keyframes successPulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .success-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-color);
        margin-bottom: 12px;
      }

      .success-message {
        font-size: 15px;
        color: #6b7280;
        margin-bottom: 30px;
        line-height: 1.6;
      }

      .queue-position-box {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        border: 2px solid #f59e0b;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
      }

      .queue-label {
        font-size: 14px;
        font-weight: 600;
        color: #92400e;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }

      .queue-number {
        font-size: 48px;
        font-weight: 700;
        color: #b45309;
      }

      .queue-text {
        font-size: 16px;
        color: #92400e;
        margin-top: 8px;
        font-weight: 600;
      }

      .tracking-number-box {
        background: linear-gradient(135deg, #dbeafe, #bfdbfe);
        border: 2px dashed var(--primary-color);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
      }

      .tracking-label {
        font-size: 14px;
        font-weight: 600;
        color: #1e40af;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
      }

      .tracking-number {
        font-size: 36px;
        font-weight: 700;
        color: var(--primary-color);
        letter-spacing: 3px;
        font-family: "Courier New", monospace;
      }

      .copy-btn {
        width: 100%;
        padding: 16px;
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
      }

      .copy-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
      }

      .copy-btn.copied {
        background: linear-gradient(135deg, var(--success-color), #059669);
      }

      .close-modal-btn {
        width: 100%;
        padding: 16px;
        background: #f3f4f6;
        color: #6b7280;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .close-modal-btn:hover {
        background: #e5e7eb;
      }

      @media (max-width: 480px) {
        .container {
          padding: 40px 25px;
        }

        .clinic-name {
          font-size: 24px;
        }

        .success-modal-content {
          padding: 40px 25px;
        }

        .tracking-number {
          font-size: 28px;
        }

        .queue-number {
          font-size: 40px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="logo-container">
          <img
            id="clinicLogo"
            src=""
            alt="Logo Clinique"
            style="display: none"
          />
          <div class="logo-placeholder" id="logoPlaceholder">üè•</div>
        </div>
        <h1 class="clinic-name" id="clinicName">Clinique M√©dicale</h1>
        <p class="clinic-subtitle" id="clinicSubtitle">R√©servation en ligne</p>
      </div>

      <div class="form-info">
        <p class="form-info-text">
          ‚ú® R√©servez votre place en quelques secondes. Vous recevrez un num√©ro
          de suivi unique et votre position dans la file d'attente.
        </p>
      </div>

      <form id="reservationForm">
        <div class="form-group">
          <label for="date">
            üìÖ Date du rendez-vous
            <span class="required-star">*</span>
          </label>
          <input type="date" id="date" name="date" required />
        </div>

        <div class="form-group">
          <label for="name">
            üë§ Nom complet
            <span class="required-star">*</span>
          </label>
          <div style="position: relative">
            <input
              type="text"
              id="name"
              name="name"
              placeholder="Ex: Ahmed Ben Ali"
              minlength="3"
              maxlength="100"
              required
            />
            <div class="input-icon" id="nameIcon"></div>
          </div>
          <div class="input-error">‚ö†Ô∏è Nom invalide (minimum 3 caract√®res)</div>
        </div>

        <div class="form-group">
          <label for="phone">
            üì± Num√©ro de t√©l√©phone
            <span class="required-star">*</span>
          </label>
          <div style="position: relative">
            <input
              type="tel"
              id="phone"
              name="phone"
              placeholder="0555123456"
              minlength="10"
              maxlength="10"
              required
            />
            <div class="input-icon" id="phoneIcon"></div>
          </div>
          <div class="input-error">‚ö†Ô∏è Format invalide (Ex: 0555123456)</div>
        </div>

        <div class="form-group">
          <label for="age">
            üéÇ √Çge
            <span class="required-star">*</span>
          </label>
          <div style="position: relative">
            <input
              type="number"
              id="age"
              name="age"
              placeholder="Ex: 35"
              min="1"
              max="120"
              required
            />
            <div class="input-icon" id="ageIcon"></div>
          </div>
          <div class="input-error">‚ö†Ô∏è √Çge invalide (1-120 ans)</div>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">
          <span>‚úì Confirmer ma r√©servation</span>
        </button>
      </form>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="success-modal">
      <div class="success-modal-content">
        <div class="success-icon">‚úì</div>
        <h2 class="success-title">R√©servation confirm√©e !</h2>
        <p class="success-message">
          F√©licitations ! Votre rendez-vous a √©t√© enregistr√© avec succ√®s.
        </p>

        <div class="queue-position-box">
          <div class="queue-label">Votre position</div>
          <div class="queue-number">#<span id="queuePosition">0</span></div>
          <div class="queue-text">dans la file d'attente</div>
        </div>

        <div class="tracking-number-box">
          <div class="tracking-label">üìã Num√©ro de suivi</div>
          <div class="tracking-number" id="trackingNumber">------</div>
        </div>

        <button class="copy-btn" id="copyBtn" onclick="copyTrackingNumber()">
          <span id="copyIcon">üìã</span>
          <span id="copyText">Copier le num√©ro de suivi</span>
        </button>

        <button class="close-modal-btn" onclick="closeSuccessModal()">
          Fermer
        </button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // ============================================
      // CONFIGURATION SUPABASE
      // ============================================
      const SUPABASE_URL = "https://xgahasrfktpyldjkndhh.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnYWhhc3Jma3RweWxkamtuZGhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5MDMyMzgsImV4cCI6MjA4MjQ3OTIzOH0.0Oec4OpBjHS5OL6QMY3bvs3jT2KGfkvECgGKZfNLXb4";

      // Initialiser le client Supabase
      const supabaseClient = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_KEY,
      );

      // Get clinic ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      const clinicId = urlParams.get("clinic");

      // ============================================
      // CONFIGURATION DE LA MARQUE
      // ============================================
      let clinicConfig = {
        id: null,
        name: "Clinique M√©dicale",
        subtitle: "R√©servation en ligne",
        primaryColor: "#2563eb",
        secondaryColor: "#1e40af",
        logoUrl: "",
      };

      let currentTrackingNumber = "";

      // Load clinic configuration
      async function loadClinicConfig() {
        if (!clinicId) {
          console.warn("No clinic ID provided");
          applyBranding();
          return;
        }

        try {
          const { data, error } = await supabaseClient
            .from("clinics")
            .select("*")
            .eq("id", clinicId)
            .eq("active", true)
            .single();

          if (error) throw error;

          if (data) {
            clinicConfig = {
              id: data.id,
              name: data.name,
              subtitle: data.subtitle || "R√©servation en ligne",
              primaryColor: data.primary_color,
              secondaryColor: data.secondary_color,
              logoUrl: data.logo_url || "",
            };
          }

          applyBranding();
        } catch (error) {
          console.error("Error loading clinic config:", error);
          document.body.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; text-align: center; padding: 20px;">
                        <div>
                            <h1 style="font-size: 48px; margin-bottom: 20px;">‚ùå</h1>
                            <h2 style="font-size: 24px; color: #1f2937; margin-bottom: 10px;">Clinique introuvable</h2>
                            <p style="color: #6b7280;">L'URL de cette clinique est invalide ou la clinique est inactive.</p>
                        </div>
                    </div>
                `;
        }
      }

      // Appliquer la marque
      function applyBranding() {
        document.getElementById("clinicName").textContent = clinicConfig.name;
        document.getElementById("clinicSubtitle").textContent =
          clinicConfig.subtitle;

        document.documentElement.style.setProperty(
          "--primary-color",
          clinicConfig.primaryColor,
        );
        document.documentElement.style.setProperty(
          "--secondary-color",
          clinicConfig.secondaryColor,
        );

        if (clinicConfig.logoUrl) {
          const logoImg = document.getElementById("clinicLogo");
          logoImg.src = clinicConfig.logoUrl;
          logoImg.style.display = "block";
          document.getElementById("logoPlaceholder").style.display = "none";
        }
      }

      // Validation en temps r√©el
      const nameInput = document.getElementById("name");
      const phoneInput = document.getElementById("phone");
      const ageInput = document.getElementById("age");

      const nameIcon = document.getElementById("nameIcon");
      const phoneIcon = document.getElementById("phoneIcon");
      const ageIcon = document.getElementById("ageIcon");

      // Validation du nom
      nameInput.addEventListener("input", function () {
        const value = this.value.trim();

        if (value.length === 0) {
          this.classList.remove("valid", "error");
          nameIcon.classList.remove("show");
        } else if (value.length >= 3) {
          this.classList.add("valid");
          this.classList.remove("error");
          nameIcon.textContent = "‚úì";
          nameIcon.classList.add("show", "valid");
          nameIcon.classList.remove("error");
        } else {
          this.classList.add("error");
          this.classList.remove("valid");
          nameIcon.textContent = "‚úó";
          nameIcon.classList.add("show", "error");
          nameIcon.classList.remove("valid");
        }
      });

      // Validation du t√©l√©phone
      phoneInput.addEventListener("input", function () {
        let value = this.value.replace(/\D/g, "");
        if (value.length > 10) value = value.slice(0, 10);
        this.value = value;

        if (value.length === 0) {
          this.classList.remove("valid", "error");
          phoneIcon.classList.remove("show");
        } else if (value.length === 10 && /^0[5-7][0-9]{8}$/.test(value)) {
          this.classList.add("valid");
          this.classList.remove("error");
          phoneIcon.textContent = "‚úì";
          phoneIcon.classList.add("show", "valid");
          phoneIcon.classList.remove("error");
        } else {
          this.classList.add("error");
          this.classList.remove("valid");
          phoneIcon.textContent = "‚úó";
          phoneIcon.classList.add("show", "error");
          phoneIcon.classList.remove("valid");
        }
      });

      // Validation de l'√¢ge
      ageInput.addEventListener("input", function () {
        const value = parseInt(this.value);

        if (!this.value) {
          this.classList.remove("valid", "error");
          ageIcon.classList.remove("show");
        } else if (value >= 1 && value <= 120) {
          this.classList.add("valid");
          this.classList.remove("error");
          ageIcon.textContent = "‚úì";
          ageIcon.classList.add("show", "valid");
          ageIcon.classList.remove("error");
        } else {
          this.classList.add("error");
          this.classList.remove("valid");
          ageIcon.textContent = "‚úó";
          ageIcon.classList.add("show", "error");
          ageIcon.classList.remove("valid");
        }
      });

      // G√©n√©rer un num√©ro de suivi unique
      function generateTrackingNumber() {
        const prefix = "TRK";
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.floor(Math.random() * 1000)
          .toString()
          .padStart(3, "0");
        return `${prefix}${timestamp}${random}`;
      }

      // D√©finir la date minimale √† aujourd'hui
      function setMinDate() {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("date").min = today;
        document.getElementById("date").value = today;
      }

      // Obtenir la position dans la file
      async function getQueuePosition(date, clinicId) {
        try {
          const { data, error } = await supabaseClient
            .from("reservations")
            .select("id")
            .eq("date", date)
            .eq("clinic_id", clinicId);

          if (error) throw error;
          return (data?.length || 0) + 1;
        } catch (error) {
          console.error("Erreur lors du calcul de la position:", error);
          return 0;
        }
      }

      // Afficher le modal de succ√®s
      function showSuccessModal(trackingNumber, queuePosition) {
        currentTrackingNumber = trackingNumber;
        document.getElementById("trackingNumber").textContent = trackingNumber;
        document.getElementById("queuePosition").textContent = queuePosition;
        document.getElementById("successModal").classList.add("show");
      }

      // Fermer le modal de succ√®s
      function closeSuccessModal() {
        document.getElementById("successModal").classList.remove("show");
        document.getElementById("reservationForm").reset();
        setMinDate();

        // R√©initialiser les ic√¥nes de validation
        document.querySelectorAll(".input-icon").forEach((icon) => {
          icon.classList.remove("show", "valid", "error");
        });
        document.querySelectorAll("input").forEach((input) => {
          input.classList.remove("valid", "error");
        });

        // R√©initialiser le bouton de copie
        document.getElementById("copyBtn").classList.remove("copied");
        document.getElementById("copyText").textContent =
          "Copier le num√©ro de suivi";
        document.getElementById("copyIcon").textContent = "üìã";
      }

      // Copier le num√©ro de suivi
      function copyTrackingNumber() {
        navigator.clipboard
          .writeText(currentTrackingNumber)
          .then(() => {
            const btn = document.getElementById("copyBtn");
            const icon = document.getElementById("copyIcon");
            const text = document.getElementById("copyText");

            btn.classList.add("copied");
            icon.textContent = "‚úì";
            text.textContent = "Copi√© avec succ√®s !";

            setTimeout(() => {
              btn.classList.remove("copied");
              icon.textContent = "üìã";
              text.textContent = "Copier le num√©ro de suivi";
            }, 3000);
          })
          .catch((err) => {
            console.error("Erreur de copie:", err);
            alert("Num√©ro de suivi: " + currentTrackingNumber);
          });
      }

      // G√©rer la soumission du formulaire
      document
        .getElementById("reservationForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Validation finale
          if (!this.checkValidity()) {
            // Marquer les champs invalides
            const inputs = this.querySelectorAll("input");
            inputs.forEach((input) => {
              if (!input.validity.valid) {
                input.classList.add("error");
              }
            });
            return;
          }

          const submitBtn = document.getElementById("submitBtn");
          submitBtn.disabled = true;
          submitBtn.innerHTML = "<span>‚è≥ Envoi en cours...</span>";

          const trackingNumber = generateTrackingNumber();
          const selectedDate = document.getElementById("date").value;

          const formData = {
            date: selectedDate,
            name: document.getElementById("name").value.trim(),
            phone: document.getElementById("phone").value.trim(),
            age: parseInt(document.getElementById("age").value),
            tracking_number: trackingNumber,
            clinic_id: clinicConfig.id,
          };

          try {
            // Obtenir la position dans la file avant l'insertion
            const queuePosition = await getQueuePosition(
              selectedDate,
              clinicConfig.id,
            );

            // Ins√©rer les donn√©es dans Supabase
            const { data, error } = await supabaseClient
              .from("reservations")
              .insert([formData])
              .select();

            if (error) throw error;

            // Afficher le modal de succ√®s avec le num√©ro de suivi et la position
            showSuccessModal(trackingNumber, queuePosition);
          } catch (error) {
            alert(
              "√âchec de la soumission de la r√©servation. Veuillez r√©essayer.",
            );
            console.error("Erreur:", error);
          } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = "<span>‚úì Confirmer ma r√©servation</span>";
          }
        });

      // Fermer le modal en cliquant √† l'ext√©rieur
      window.onclick = function (event) {
        const modal = document.getElementById("successModal");
        if (event.target === modal) {
          closeSuccessModal();
        }
      };

      // Initialiser
      loadClinicConfig();
      setMinDate();
    </script>
  </body>
</html>
